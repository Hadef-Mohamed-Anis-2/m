<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="profilestyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- ÿ•ÿ∂ÿßŸÅÿ© Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÜŸÖÿßÿ∑ ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ */
        .user-posts-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            direction: rtl;
        }
        
        .user-post-item {
            background-color: var(--white, #fff);
            border: 1px solid var(--light-grey, #ccc);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: var(--dark-grey, #333);
        }
        
        .user-post-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .user-post-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-yellow, #ffc400);
        }
        
        .user-post-username {
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-post-time {
            font-size: 11px;
            color: var(--medium-grey, #555);
            margin-right: auto;
        }
        
        .user-post-content {
            font-size: 14px;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }
        
        .user-post-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .user-post-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--medium-grey, #555);
            border-top: 1px solid var(--light-grey, #eee);
            padding-top: 8px;
        }
        
        .no-posts-message {
            text-align: center;
            color: var(--medium-grey, #555);
            padding: 20px;
            font-style: italic;
        }
        
        .posts-loading {
            text-align: center;
            padding: 20px;
            color: var(--medium-grey, #555);
        }
        
        .error-message {
            text-align: center;
            color: var(--red, #f00);
            padding: 20px;
            background-color: rgba(255,0,0,0.1);
            border-radius: 8px;
            margin: 10px;
        }
        
        .debug-info {
            font-size: 10px;
            color: var(--medium-grey, #555);
            background-color: rgba(0,0,0,0.05);
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
        }

        /* ÿ£ŸÜŸÖÿßÿ∑ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ± */
        .friend-btn {
            background-color: var(--primary-yellow, #ffc400);
            color: var(--dark-grey, #333);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .friend-btn:hover {
            background-color: var(--dark-grey, #333);
            color: var(--primary-yellow, #ffc400);
            transform: translateY(-2px);
        }

        .friend-btn.remove {
            background-color: var(--red, #f00);
            color: var(--white, #fff);
        }

        .friend-btn.remove:hover {
            background-color: #cc0000;
        }

        .friend-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .current-user-badge {
            background-color: var(--primary-yellow, #ffc400);
            color: var(--dark-grey, #333);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--white, #fff);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            direction: ltr;
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.success .toast-icon {
            color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.error .toast-icon {
            color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.warning .toast-icon {
            color: #ffc107;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--medium-grey, #555);
            margin: 0;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--medium-grey, #555);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: var(--dark-grey, #333);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }

        /* Friends List Styles */
        .friends-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            direction: rtl;
        }

        .friend-item {
            background-color: var(--white, #fff);
            border: 1px solid var(--light-grey, #ccc);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-yellow, #ffc400);
            border: 2px solid var(--primary-yellow, #ffc400);
            flex-shrink: 0;
        }

        .friend-info {
            flex-grow: 1;
        }

        .friend-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--dark-grey, #333);
        }

        .friend-added {
            font-size: 12px;
            color: var(--medium-grey, #555);
        }

        .friend-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .friend-action-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .friend-action-btn.view {
            background-color: var(--primary-yellow, #ffc400);
            color: var(--dark-grey, #333);
        }

        .friend-action-btn.chat {
            background-color: #007bff;
            color: white;
        }

        .friend-action-btn.remove {
            background-color: var(--red, #f00);
            color: white;
        }

        .friend-action-btn:hover {
            transform: scale(1.1);
        }

        .friend-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .no-friends-message {
            text-align: center;
            color: var(--medium-grey, #555);
            padding: 40px 20px;
            font-style: italic;
        }

        .friends-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-grey, #555);
        }

        /* Tab Navigation */
        .profile-tabs {
            display: flex;
            background-color: var(--medium-grey, #555);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
        }

        .profile-tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            background: none;
            border: none;
            color: var(--white, #fff);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .profile-tab.active {
            background-color: var(--primary-yellow, #ffc400);
            color: var(--dark-grey, #333);
        }

        .profile-tab:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="game-interface-container">

        <div class="popup-window profile-window">
            
            <div class="window-header">
                <a href="main.html" style="text-decoration: none; margin-right: auto; order: -1;">
                    <button class="window-control-btn back-btn" aria-label="Return">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </a>
                
                <span class="header-icon"></span>
                <span class="header-title" style="padding-right: 10px;">User Profile</span>
            </div>

            <div class="window-body profile-body">
                
                <div class="header-frame frame-one">
                    <div class="profile-info">
                        <div class="profile-icon" id="profile-icon"></div> 
                        <div class="user-details">
                            <span class="username" id="username-display">Guest</span> 
                            <div class="subscribers">Subscribers <span>0</span></div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <span id="current-user-badge" class="current-user-badge" style="display: none;">You</span>
                        <button class="add-btn" aria-label="Upload Photo" id="upload-btn" style="display: none;">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="friend-btn" id="friend-btn" style="display: none;">
                            <i class="fas fa-user-plus"></i>
                            <span>Add Friend</span>
                        </button>
                    </div>
                </div>

                <input type="file" id="file-input" accept="image/*" style="display: none;">

                <div class="main-content-area"> 
                    <!-- Tab Navigation -->
                    <div class="profile-tabs">
                        <button class="profile-tab active" data-tab="posts">
                            <i class="fas fa-newspaper"></i> Posts
                        </button>
                        <button class="profile-tab" data-tab="friends">
                            <i class="fas fa-users"></i> Friends
                        </button>
                        <button class="profile-tab" data-tab="achievements">
                            <i class="fas fa-trophy"></i> Achievements
                        </button>
                    </div>

                    <!-- Posts Tab -->
                    <div class="tab-content active" id="posts-tab">
                        <div class="user-posts-container" id="user-posts-container">
                            <div class="posts-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading posts...
                            </div>
                        </div>
                    </div>

                    <!-- Friends Tab -->
                    <div class="tab-content" id="friends-tab">
                        <div class="friends-container" id="friends-container">
                            <div class="friends-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading friends...
                            </div>
                        </div>
                    </div>

                    <!-- Achievements Tab -->
                    <div class="tab-content" id="achievements-tab">
                        <div class="no-posts-message">
                            <i class="fas fa-trophy" style="font-size: 3em; margin-bottom: 15px; color: var(--primary-yellow);"></i>
                            <br>
                            Achievements system coming soon!
                            <br>
                            <span style="font-size: 0.9em; color: var(--medium-grey);">
                                Complete challenges and earn rewards
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ****************************************************
        // Firebase Configuration
        // ****************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyChvtHVmDn-jGkPCUgeyTOWF1GwwC5Se7g",
            authDomain: "devgame-69208.firebaseapp.com",
            projectId: "devgame-69208",
            storageBucket: "devgame-69208.firebasestorage.app",
            messagingSenderId: "359568777421",
            appId: "1:359568777421:web:0c30c804aa0ffe95608984",
            measurementId: "G-D6YELCJ51C"
        };

        // Initialize Firebase
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // ****************************************************
        // Cloudinary Configuration
        // ****************************************************
        const CLOUDINARY_CLOUD_NAME = "dsvxv96q8";
        const CLOUDINARY_UPLOAD_PRESET = "DevGame";

        // localStorage Keys - UPDATED WITH USER-SPECIFIC KEYS
        const USER_NAME_KEY = 'game_user_name';
        const USER_ID_KEY = 'game_user_id';

        // NEW: User-specific keys for profile pictures
        function getProfilePicKey() {
            const userId = localStorage.getItem(USER_ID_KEY) || 'guest';
            return `profile_pic_${userId}`;
        }

        function getGooglePhotoKey() {
            const userId = localStorage.getItem(USER_ID_KEY) || 'guest';
            return `google_photo_${userId}`;
        }

        // Function to get current user data - UPDATED
        function getCurrentUserData() {
            const userId = localStorage.getItem(USER_ID_KEY) || 'guest_user_' + Math.random().toString(16).slice(2, 8);
            const userName = localStorage.getItem(USER_NAME_KEY) || 'Guest User';
            
            // Get user-specific profile picture
            const profilePicKey = getProfilePicKey();
            const googlePhotoKey = getGooglePhotoKey();
            const userProfilePic = localStorage.getItem(profilePicKey);
            const userGooglePhoto = localStorage.getItem(googlePhotoKey);
            
            return {
                id: userId,
                name: userName,
                avatar: userProfilePic || userGooglePhoto || 'https://via.placeholder.com/100/ffc400/333?text=G'
            };
        }

        // Function to save profile picture - UPDATED
        function saveProfilePicture(imageUrl) {
            const profilePicKey = getProfilePicKey();
            localStorage.setItem(profilePicKey, imageUrl);
            
            // Remove old global keys if exist (for backward compatibility)
            localStorage.removeItem('game_profile_pic_url');
            localStorage.removeItem('game_google_photo_url');
        }

        // Function to save google photo - UPDATED
        function saveGooglePhoto(imageUrl) {
            const googlePhotoKey = getGooglePhotoKey();
            localStorage.setItem(googlePhotoKey, imageUrl);
        }

        // Function to migrate old data to new system - NEW
        function migrateOldProfileData() {
            const oldProfilePic = localStorage.getItem('game_profile_pic_url');
            const oldGooglePhoto = localStorage.getItem('game_google_photo_url');
            
            if (oldProfilePic) {
                saveProfilePicture(oldProfilePic);
                localStorage.removeItem('game_profile_pic_url');
            }
            
            if (oldGooglePhoto) {
                saveGooglePhoto(oldGooglePhoto);
                localStorage.removeItem('game_google_photo_url');
            }
        }

        let CURRENT_USER = getCurrentUserData();
        let VIEWED_USER = null; // Currently viewed user
        let isViewingOwnProfile = true; // Is user viewing their own profile?
        let isFriend = false; // Is the viewed user a friend of current user?

        // ****************************************************
        // Toast Notification System
        // ****************************************************
        function showToast(type, title, message, duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle'
            };

            toast.innerHTML = `
                <i class="toast-icon ${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <p class="toast-message">${message}</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            toastContainer.appendChild(toast);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('hiding');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }

            return toast;
        }

        // ****************************************************
        // Tab Navigation System
        // ****************************************************
        function initializeTabs() {
            const tabs = document.querySelectorAll('.profile-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show target content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${targetTab}-tab`) {
                            content.classList.add('active');
                        }
                    });

                    // Load friends if friends tab is activated
                    if (targetTab === 'friends') {
                        loadFriendsList();
                    }
                });
            });
        }

        // ****************************************************
        // Utility Functions
        // ****************************************************
        
        // Function to calculate time since post
        function timeSince(date) {
            if (!date) return "Unknown";
            
            const postDate = date instanceof Date ? date : date.toDate();
            const seconds = Math.floor((new Date() - postDate) / 1000);
            let interval = Math.floor(seconds / 31536000);

            if (interval >= 1) {
                return interval + (interval === 1 ? " year ago" : " years ago");
            }
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) {
                return interval + (interval === 1 ? " month ago" : " months ago");
            }
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) {
                return interval + (interval === 1 ? " day ago" : " days ago");
            }
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) {
                return interval + (interval === 1 ? " hour ago" : " hours ago");
            }
            interval = Math.floor(seconds / 60);
            if (interval >= 1) {
                return interval + (interval === 1 ? " minute ago" : " minutes ago");
            }
            return "Just now";
        }

        // Function to extract hashtags from text
        function extractAndLinkHashtags(text) {
            if (!text) return { linkedText: '', tags: [] };
            
            const hashtagRegex = /#([\w\u0621-\u064A]+)/g;
            const extractedTags = new Set();
            
            const linkedText = text.replace(hashtagRegex, (match, tag) => {
                const cleanTag = tag.toLowerCase();
                extractedTags.add(cleanTag);
                return `<span style="color: var(--red, #f00); font-weight: bold;">#${tag}</span>`;
            });
            
            return { linkedText: linkedText, tags: Array.from(extractedTags) };
        }

        // ****************************************************
        // Friendship System - IMPROVED VERSION
        // ****************************************************

        // Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ (ÿ™ÿ∂ŸäŸÅ ŸÉŸÑÿß ÿßŸÑÿ∑ÿ±ŸÅŸäŸÜ)
        async function addFriend() {
            if (!VIEWED_USER || !CURRENT_USER.id || isFriend) return;

            const friendBtn = document.getElementById('friend-btn');
            friendBtn.disabled = true;
            friendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                console.log("‚ûï Adding friend:", VIEWED_USER.id);
                console.log("Current user:", CURRENT_USER.id);
                
                // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ© ŸÑŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä)
                const friendData1 = {
                    friendId: VIEWED_USER.id,
                    friendName: VIEWED_USER.name,
                    friendAvatar: VIEWED_USER.avatar,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ© ŸÑŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ´ÿßŸÜŸä (ÿßŸÑÿµÿØŸäŸÇ)
                const friendData2 = {
                    friendId: CURRENT_USER.id,
                    friendName: CURRENT_USER.name,
                    friendAvatar: CURRENT_USER.avatar,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                console.log("Friend data to save:", friendData1, friendData2);

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿµÿØŸäŸÇ ŸÑŸÉŸÑÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                const batch = db.batch();
                
                // ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä)
                const friendRef1 = db.collection('friendships')
                    .doc(CURRENT_USER.id)
                    .collection('friends')
                    .doc(VIEWED_USER.id);
                batch.set(friendRef1, friendData1);

                // ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ´ÿßŸÜŸä (ÿßŸÑÿµÿØŸäŸÇ)
                const friendRef2 = db.collection('friendships')
                    .doc(VIEWED_USER.id)
                    .collection('friends')
                    .doc(CURRENT_USER.id);
                batch.set(friendRef2, friendData2);

                // ÿ™ŸÜŸÅŸäÿ∞ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ŸÖÿπŸãÿß
                await batch.commit();

                console.log("‚úÖ Friend added successfully to both users");
                isFriend = true;
                updateFriendButton();
                showToast('success', 'Friend Added', 'You are now friends with ' + VIEWED_USER.name);
                
            } catch (error) {
                console.error("‚ùå Error adding friend:", error);
                console.error("Error code:", error.code);
                console.error("Error message:", error.message);
                
                let errorMessage = 'Failed to add friend: ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'No write permission. Check Firebase security rules.';
                } else if (error.code === 'not-found') {
                    errorMessage += 'Document not found.';
                } else {
                    errorMessage += error.message;
                }
                
                showToast('error', 'Add Friend Failed', errorMessage);
            } finally {
                friendBtn.disabled = false;
                updateFriendButton();
            }
        }

        // Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ≠ÿ∞ŸÅ ÿµÿØŸäŸÇ (ÿ™ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÉŸÑÿß ÿßŸÑÿ∑ÿ±ŸÅŸäŸÜ)
        async function removeFriend(friendId, friendName) {
            if (!friendId || !CURRENT_USER.id) return;

            try {
                console.log("‚ûñ Removing friend:", friendId);
                
                // ÿ≠ÿ∞ŸÅ ÿßŸÑÿµÿØŸäŸÇ ŸÖŸÜ ŸÉŸÑÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                const batch = db.batch();
                
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
                const friendRef1 = db.collection('friendships')
                    .doc(CURRENT_USER.id)
                    .collection('friends')
                    .doc(friendId);
                batch.delete(friendRef1);

                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿµÿØŸäŸÇ
                const friendRef2 = db.collection('friendships')
                    .doc(friendId)
                    .collection('friends')
                    .doc(CURRENT_USER.id);
                batch.delete(friendRef2);

                // ÿ™ŸÜŸÅŸäÿ∞ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ŸÖÿπŸãÿß
                await batch.commit();

                showToast('success', 'Friend Removed', 'You are no longer friends with ' + friendName);
                
                // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                isFriend = false;
                updateFriendButton();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°
                loadFriendsList();
                
            } catch (error) {
                console.error("‚ùå Error removing friend:", error);
                console.error("Error code:", error.code);
                console.error("Error message:", error.message);
                
                let errorMessage = 'Failed to remove friend: ';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'No write permission. Check Firebase security rules.';
                } else if (error.code === 'not-found') {
                    errorMessage += 'Friend not found.';
                } else {
                    errorMessage += error.message;
                }
                
                showToast('error', 'Remove Friend Failed', errorMessage);
            }
        }

        // Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿµÿØÿßŸÇÿ©
        async function checkFriendshipStatus() {
            if (!VIEWED_USER || !CURRENT_USER.id || CURRENT_USER.id === VIEWED_USER.id) {
                isFriend = false;
                updateFriendButton();
                return;
            }

            try {
                console.log("üîç Checking friendship between:", CURRENT_USER.id, "and", VIEWED_USER.id);
                
                const friendsRef = db.collection('friendships')
                    .doc(CURRENT_USER.id)
                    .collection('friends')
                    .doc(VIEWED_USER.id);

                const friendsDoc = await friendsRef.get();

                if (!friendsDoc.exists) {
                    console.log("‚ùå Friendship document does not exist");
                    isFriend = false;
                } else {
                    console.log("‚úÖ Friendship document exists:", friendsDoc.data());
                    isFriend = true;
                }
                
                updateFriendButton();
            } catch (error) {
                console.error("‚ùå Error checking friendship:", error);
                console.error("Error details:", error.code, error.message);
                isFriend = false;
                updateFriendButton();
            }
        }

        // Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≤ÿ± ÿßŸÑÿµÿØÿßŸÇÿ©
        function updateFriendButton() {
            const friendBtn = document.getElementById('friend-btn');
            const currentUserBadge = document.getElementById('current-user-badge');
            const uploadBtn = document.getElementById('upload-btn');

            if (isViewingOwnProfile) {
                // Viewing own profile
                friendBtn.style.display = 'none';
                currentUserBadge.style.display = 'inline-block';
                uploadBtn.style.display = 'block';
            } else {
                // Viewing other user's profile
                friendBtn.style.display = 'flex';
                currentUserBadge.style.display = 'none';
                uploadBtn.style.display = 'none';

                if (isFriend) {
                    friendBtn.innerHTML = '<i class="fas fa-user-minus"></i><span>Remove Friend</span>';
                    friendBtn.className = 'friend-btn remove';
                    friendBtn.onclick = () => removeFriend(VIEWED_USER.id, VIEWED_USER.name);
                } else {
                    friendBtn.innerHTML = '<i class="fas fa-user-plus"></i><span>Add Friend</span>';
                    friendBtn.className = 'friend-btn';
                    friendBtn.onclick = addFriend;
                }
                
                friendBtn.disabled = false;
            }
        }

        // Function to load friends list
        async function loadFriendsList() {
            const friendsContainer = document.getElementById('friends-container');
            const targetUserId = isViewingOwnProfile ? CURRENT_USER.id : (VIEWED_USER ? VIEWED_USER.id : null);
            
            if (!targetUserId) {
                friendsContainer.innerHTML = `
                    <div class="no-friends-message">
                        <i class="fas fa-user-friends" style="font-size: 3em; margin-bottom: 15px; color: var(--medium-grey);"></i>
                        <br>
                        Cannot load friends - User ID not found
                    </div>
                `;
                return;
            }

            friendsContainer.innerHTML = '<div class="friends-loading"><i class="fas fa-spinner fa-spin"></i> Loading friends...</div>';

            try {
                const friendsSnapshot = await db.collection('friendships')
                    .doc(targetUserId)
                    .collection('friends')
                    .orderBy('addedAt', 'desc')
                    .get();

                console.log("‚úÖ Number of friends found:", friendsSnapshot.size);
                
                friendsContainer.innerHTML = '';

                if (friendsSnapshot.empty) {
                    friendsContainer.innerHTML = `
                        <div class="no-friends-message">
                            <i class="fas fa-user-friends" style="font-size: 3em; margin-bottom: 15px; color: var(--medium-grey);"></i>
                            <br>
                            ${isViewingOwnProfile ? 'No friends yet' : 'This user has no friends yet'}
                            <br>
                            <span style="font-size: 0.9em; color: var(--medium-grey);">
                                ${isViewingOwnProfile ? 'Start adding friends to see them here!' : 'Be the first to add them as a friend!'}
                            </span>
                        </div>
                    `;
                    return;
                }

                friendsSnapshot.forEach((doc) => {
                    const friendData = doc.data();
                    const friendElement = createFriendElement(friendData);
                    friendsContainer.appendChild(friendElement);
                });

            } catch (error) {
                console.error("‚ùå Error loading friends list:", error);
                friendsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error loading friends<br>
                        <div class="debug-info">${error.message}</div>
                    </div>
                `;
            }
        }

        // Function to create friend element
        function createFriendElement(friendData) {
            const friendElement = document.createElement('div');
            friendElement.className = 'friend-item';

            const addedTime = friendData.addedAt ? timeSince(friendData.addedAt) : 'Recently';

            friendElement.innerHTML = `
                <div class="friend-avatar" style="background-image: url('${friendData.friendAvatar}')"></div>
                <div class="friend-info">
                    <div class="friend-name">${friendData.friendName}</div>
                    <div class="friend-added">Added ${addedTime}</div>
                </div>
                <div class="friend-actions">
                    <button class="friend-action-btn view" onclick="viewFriendProfile('${friendData.friendId}', '${friendData.friendName}', '${friendData.friendAvatar}')" title="View Profile">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="friend-action-btn chat" onclick="startChatWithFriend('${friendData.friendId}', '${friendData.friendName}')" title="Start Chat" disabled>
                        <i class="fas fa-comment"></i>
                    </button>
                    ${isViewingOwnProfile ? `
                    <button class="friend-action-btn remove" onclick="removeFriend('${friendData.friendId}', '${friendData.friendName}')" title="Remove Friend">
                        <i class="fas fa-user-minus"></i>
                    </button>
                    ` : ''}
                </div>
            `;

            return friendElement;
        }

        // Function to view friend profile
        function viewFriendProfile(friendId, friendName, friendAvatar) {
            const params = new URLSearchParams({
                user_id: friendId,
                user_name: friendName,
                user_avatar: friendAvatar
            });
            window.location.href = `profile.html?${params.toString()}`;
        }

        // Function to start chat with friend (placeholder)
        function startChatWithFriend(friendId, friendName) {
            showToast('warning', 'Chat Feature', 'Chat system is coming soon! You will be able to chat with ' + friendName);
            // TODO: Implement chat functionality later
        }

        // ****************************************************
        // Posts System
        // ****************************************************

        // Function to load and display user posts
        function loadUserPosts() {
            const postsContainer = document.getElementById('user-posts-container');
            const targetUserId = VIEWED_USER ? VIEWED_USER.id : CURRENT_USER.id;
            
            console.log("üìù Loading posts for user:", targetUserId);
            console.log("üëÄ VIEWED_USER:", VIEWED_USER);
            console.log("üë§ CURRENT_USER:", CURRENT_USER);
            console.log("üè† isViewingOwnProfile:", isViewingOwnProfile);
            
            // Allow viewing other users' posts even if current user is guest
            if (!targetUserId) {
                postsContainer.innerHTML = `
                    <div class="no-posts-message">
                        Cannot load posts - User ID not found
                        <div class="debug-info">User ID: ${targetUserId}</div>
                    </div>
                `;
                return;
            }

            postsContainer.innerHTML = '<div class="posts-loading"><i class="fas fa-spinner fa-spin"></i> Loading posts...</div>';

            try {
                // Use get instead of onSnapshot for simplicity
                const query = db.collection('posts')
                    .where('userId', '==', targetUserId)
                    .orderBy('timestamp', 'desc')
                    .limit(20);

                query.get().then((snapshot) => {
                    console.log("‚úÖ Number of posts found:", snapshot.size);
                    
                    postsContainer.innerHTML = '';

                    if (snapshot.empty) {
                        postsContainer.innerHTML = `
                            <div class="no-posts-message">
                                ${isViewingOwnProfile ? 'You haven\'t posted anything yet' : 'This user hasn\'t posted anything yet'}
                                <div class="debug-info">User ID: ${targetUserId}</div>
                                <div class="debug-info">Posts found: 0</div>
                            </div>
                        `;
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const postData = doc.data();
                        console.log("üìÑ Post data:", postData);
                        const postElement = createUserPostElement(postData);
                        postsContainer.appendChild(postElement);
                    });
                }).catch((error) => {
                    console.error("‚ùå Error loading user posts: ", error);
                    postsContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Error loading posts<br>
                            <div class="debug-info">${error.message}</div>
                            <div class="debug-info">User ID: ${targetUserId}</div>
                            <div class="debug-info">Error code: ${error.code}</div>
                        </div>
                    `;
                });

            } catch (error) {
                console.error("‚ùå Error in loadUserPosts:", error);
                postsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Database connection error<br>
                        <div class="debug-info">${error.message}</div>
                    </div>
                `;
            }
        }

        // Function to create user post element
        function createUserPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'user-post-item';

            const postDate = post.timestamp ? post.timestamp : new Date();
            const timeAgo = timeSince(postDate);

            const { linkedText } = extractAndLinkHashtags(post.content || '');
            
            let imageHtml = '';
            if (post.imageUrl) {
                imageHtml = `<img src="${post.imageUrl}" class="user-post-image" alt="Post Image" onerror="this.style.display='none'">`;
            }

            const displayAvatar = VIEWED_USER ? VIEWED_USER.avatar : CURRENT_USER.avatar;
            const displayName = post.userName || (VIEWED_USER ? VIEWED_USER.name : CURRENT_USER.name);

            postElement.innerHTML = `
                <div class="user-post-header">
                    <div class="user-post-avatar" style="background-image: url('${displayAvatar}')"></div>
                    <span class="user-post-username">${displayName}</span>
                    <span class="user-post-time">${timeAgo}</span>
                </div>
                <div class="user-post-content">${linkedText.replace(/\n/g, '<br>')}</div>
                ${imageHtml}
                <div class="user-post-stats">
                    <span><i class="fas fa-heart"></i> ${post.likeCount || 0}</span>
                    <span><i class="fas fa-comment"></i> ${post.commentCount || 0}</span>
                </div>
            `;

            return postElement;
        }

        // Function to reload posts
        function reloadPosts() {
            console.log("üîÑ Reloading posts...");
            loadUserPosts();
        }

        // Function to load viewed user data
        function loadViewedUserData() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewedUserId = urlParams.get('user_id');
            const viewedUserName = urlParams.get('user_name');
            const viewedUserAvatar = urlParams.get('user_avatar');

            console.log("üîó URL Parameters:", {
                viewedUserId,
                viewedUserName, 
                viewedUserAvatar
            });

            if (viewedUserId && viewedUserId !== CURRENT_USER.id) {
                // Viewing other user's profile
                isViewingOwnProfile = false;
                VIEWED_USER = {
                    id: viewedUserId,
                    name: viewedUserName || 'Unknown User',
                    avatar: viewedUserAvatar || 'https://via.placeholder.com/100/ffc400/333?text=U'
                };

                console.log("üë§ Viewing other user profile:", VIEWED_USER);

                // Update viewed user interface
                document.getElementById('username-display').textContent = VIEWED_USER.name;
                document.getElementById('profile-icon').style.backgroundImage = `url('${VIEWED_USER.avatar}')`;
                document.getElementById('profile-icon').style.backgroundSize = 'cover';
                document.getElementById('profile-icon').style.backgroundPosition = 'center';
                document.getElementById('profile-icon').style.backgroundColor = 'transparent';
                document.getElementById('profile-icon').innerHTML = '';

                // Check friendship status
                checkFriendshipStatus();
            } else {
                // Viewing own profile
                isViewingOwnProfile = true;
                VIEWED_USER = null;
                
                console.log("üè† Viewing own profile");

                // Update current user interface
                const storedUsername = localStorage.getItem(USER_NAME_KEY) || 'Guest';
                document.getElementById('username-display').textContent = storedUsername;
                
                // Get user-specific profile picture
                const profilePicKey = getProfilePicKey();
                const googlePhotoKey = getGooglePhotoKey();
                const userProfilePic = localStorage.getItem(profilePicKey);
                const userGooglePhoto = localStorage.getItem(googlePhotoKey);
                let finalImageUrl = userProfilePic || userGooglePhoto;

                if (finalImageUrl) {
                    document.getElementById('profile-icon').style.backgroundImage = `url('${finalImageUrl}')`;
                    document.getElementById('profile-icon').style.backgroundSize = 'cover';
                    document.getElementById('profile-icon').style.backgroundPosition = 'center';
                    document.getElementById('profile-icon').style.backgroundColor = 'transparent';
                    document.getElementById('profile-icon').innerHTML = '';
                } else {
                    document.getElementById('profile-icon').innerHTML = '<i class="fas fa-user-circle" style="font-size: 3em; color: #ccc;"></i>';
                }
            }

            updateFriendButton();
            loadUserPosts();
        }

        // ****************************************************
        // File Upload System - UPDATED
        // ****************************************************

        // Function to upload file to Cloudinary
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            showToast('warning', 'Uploading', 'Uploading profile picture...', 0);

            fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                return response.json().then(data => {
                    const errorMessage = data.error && data.error.message 
                                        ? data.error.message 
                                        : `Upload failed with status: ${response.status}`;
                    throw new Error(errorMessage);
                });
            })
            .then(data => {
                const imageUrl = data.secure_url;
                
                // Save using new user-specific system
                saveProfilePicture(imageUrl);

                const profileIcon = document.getElementById('profile-icon');
                profileIcon.style.backgroundImage = `url('${imageUrl}')`;
                profileIcon.style.backgroundSize = 'cover';
                profileIcon.style.backgroundPosition = 'center';
                profileIcon.style.backgroundColor = 'transparent';
                profileIcon.innerHTML = '';

                // Update current user avatar and reload posts
                CURRENT_USER.avatar = imageUrl;
                
                // Remove existing toasts and show success
                document.getElementById('toast-container').innerHTML = '';
                showToast('success', 'Upload Successful', 'Profile picture updated successfully!');
                setTimeout(reloadPosts, 1000);
            })
            .catch(error => {
                console.error('Upload Error:', error);
                document.getElementById('toast-container').innerHTML = '';
                showToast('error', 'Upload Failed', error.message);
            });
        }

        // ****************************************************
        // Event Listeners
        // ****************************************************

        document.addEventListener('DOMContentLoaded', () => {
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');

            // Migrate old data to new system
            migrateOldProfileData();

            // Update current user data
            CURRENT_USER = getCurrentUserData();
            console.log("üöÄ Current user on load:", CURRENT_USER);

            // 1. Check and clear data if user changed
            const currentUserId = localStorage.getItem(USER_ID_KEY);
            const lastUserId = localStorage.getItem('last_user_id');
            if (currentUserId && currentUserId !== lastUserId) {
                // No need to clear profile pictures anymore - they're user-specific
                localStorage.setItem('last_user_id', currentUserId);
            }

            // 2. Load viewed user data (own or other user)
            loadViewedUserData();
            
            // 3. Initialize tab navigation
            initializeTabs();
            
            // 4. Bind upload button to file input (for current user only)
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            // 5. Handle file selection (for current user only)
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && isViewingOwnProfile) {
                    uploadFile(file);
                }
            });

            // 6. Add manual refresh button
            const refreshBtn = document.createElement('button');
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            refreshBtn.style.cssText = `
                position: absolute;
                top: 10px;
                left: 10px;
                background: var(--primary-yellow, #ffc400);
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            refreshBtn.onclick = reloadPosts;
            document.querySelector('.content-frame').style.position = 'relative';
            document.querySelector('.content-frame').appendChild(refreshBtn);
        });

        // ****************************************************
        // (Previous code for preventing copy)
        // ****************************************************
        document.addEventListener('contextmenu', function(e){
            e.preventDefault();
        });

        document.addEventListener('dragstart', function(e){
            if (e.target.tagName == 'IMG'){
                e.preventDefault();
            }
        });
    </script>
</body>
</html>